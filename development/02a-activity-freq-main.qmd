---
title: "CEJS Activity"
format: html
---

Armed with all of that background knowledge on the CEJS dataset and on statistical inference, we can proceed with a detailed analysis of the data. In particular, we are interested in assessing the following hypothesis:

  > _As the population of Black Americans increases (decreases), the level of energy expenditure increases (decreases)._

In this part of the session you will interpret results from a statistical model fitted to datasets from different U.S. States.
 
<!-- solution-begin -->
::: {.callout-note icon="false" title="Instructor Note: Introduction"}
These are instructor notes; they will be removed from the student-facing assignment file.

This is the **Frequentist** form of the activity.
:::
<!-- solution-end -->

```{r setup}
#| include: false
#| echo: false
library(tidyverse)
library(broom)
library(modelr)

filename <- "../data/1.0-communities.csv"
```

```{r wrangling}
#| include: false
#| echo: false
df_raw <- read_csv(filename)
df_data <- 
  df_raw %>%
  janitor::clean_names()
```

# Overview

Throughout this activity, you will be studying a statistical model fitted to data from the CEJS dataset. As a reminder, we are interested in the `Energy Burden Percentile` (higher values correspond to a higher burden) and the `Percent Black Census Tract` (which measures the number of people in a region who are Black).

```{r fig-overview}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 3
#| fig-cap: CEJS data for Massachusetts.
df_MA <- 
  df_data %>% 
  filter(
    state_territory == "Massachusetts",
    !is.na(percent_black_or_african_american_alone),
    !is.na(energy_burden_percentile),
  )

df_MA %>%   
  ggplot(aes(
    percent_black_or_african_american_alone,
    energy_burden_percentile
  )) +
  geom_point(size = 0.1) +
  facet_wrap(~state_territory, ncol = 2) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    x = "Percent Black Census Tract",
    y = "Energy Burden Percentile",
  )
```

From this scatterplot, we can see that the energy burden seems to increase as the percent Black increases. However, we can make this rough observation more formal by using a statistical model.

# Analyze a Frequentist Model

To analyze the dataset, we will use the following statistical model,

$$ B = m P + b + \epsilon $$

where $B$ is the energy burden percentile, $P$ is the percent Black, $m$ is the slope parameter, $b$ is the intercept parameter, and $\epsilon$ is a *residual* term that represents factors not accounted in the model. The residual term is assumed to be normally distributed $\epsilon \sim N(0, \sigma^2)$ with an unknown parameter $\sigma^2$. All three parameters are assumed to have fixed but unknown values that depend on the population we aim to study, and that we will estimate imperfectly using data.

<!-- solution-begin -->

::: {.callout-note icon="false" title="Instructor Note: Model Assumptions"}
Note that this model makes a number of important assumptions, which students may identify and question. We recommend validating student input, but try to maintain a focus on the assumptions that are aligned with the lesson's learning objectives. We enumerate important model assumptions, ramifications, and relevance to learning objectives here:

-   The responses $B_i$ are independent when conditioned on the percent Black $P$.
    -   This is almost surely not true as there are a variety of other factors that affect one's energy burden, such as State-level economic policies. These other factors are not entirely captured in our lone predictor ($P$), which may manifest as association between the observed responses ($B_i$). This will lead to an *omitted variable bias* in our estimates.
    -   While omitted variable bias is an important consideration, it is outside the learning objectives in this lesson since this assumption is shared between the Frequentist and Bayesian approaches.
-   The structure of the response is linear; that is $B = m P + b + \epsilon$.
    -   This discounts the possibility of nonlinearity; for instance, there could be little change in the mean energy burden at small percent Black, but much larger change at higher values.
    -   While the structure of the response is an important consideration, it is outside the learning objectives in this lesson since this assumption is shared between the Frequentist and Bayesian approaches.
-   Residuals are normally distributed $\epsilon \sim N(0, \sigma^2)$ with constant $\sigma^2$.
    -   This will never be exactly true, which we can check by inspecting the residuals. This assumptions has implications for our predictive uncertainty; for instance, assuming a constant $\sigma^2$ discounts the possibility of heteroskedasticity.
    -   While the residual distribution is an important consideration, it is outside the learning objectives in this lesson since this assumption is shared between the Frequentist and Bayesian approaches.
-   The intercept $b$ and slope $m$ parameters are treated as fixed but unknown values.
    -   This is a fundamental component of the Frequentist approach that differs from the Bayesian approach, and hence is directly related to the lesson's learning objectives.
:::

<!-- solution-end -->

## Study the estimates

Unknown parameters are often estimated using a technique called *maximum likelihood estimation* (MLE). This is an approach that is outside the scope of this activity. However, given a model and data, we can use MLE to estimate "best fit" parameter values for the intercept $b$ and slope $m$ parameters.

When fitting a model, we should also assess the *uncertainty* in our estimated parameters. MLE estimates are usually reported with *confidence intervals* (CI), which represent a plausible range for the population parameter values we aim to estimate. The following table reports estimates and confidence intervals for the intercept and slope parameters using data from Massachusetts only.

```{r mle-MA}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
model_MA <- 
  lm(
    formula = energy_burden_percentile ~ percent_black_or_african_american_alone,
    data = df_MA,
  )

df_model_MA <- 
  model_MA %>% 
  tidy() %>% 
  mutate(
    lower = estimate - 2 * std.error,
    upper = estimate + 2 * std.error,
  )

df_model_MA %>% 
  select(term, lower, estimate, upper) %>% 
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "percent_black_or_african_american_alone" ~ "Slope"
    )
  ) %>% 
  mutate(across(
    c(lower, estimate, upper),
    ~round(., digits = 1)
  )) %>% 
  
  select(Term = term, Lower = lower, Estimate = estimate, Upper = upper) %>% 
  knitr::kable()
```

Confidence intervals helps us determine **how confident** we should be in conclusions drawn from the model. The next exercise will help you assess confidence in results based on the fitted model.

## Assessing confidence

Let's imagine three different estimates for the slope parameter $m$: These could arise from using three different datasets to estimate the same population parameters:

| Scenario | Lower | Estimate | Upper |
|----------|-------|----------|-------|
|    A     |  -23  |     2    |  +25  |
|    B     |   -5  |    15    |  +35  |
|    C     |   +5  |    13    |  +20  |

**Model summaries**

<!-- task-begin -->
::: {.callout-note icon=false title="Questions for the Class"}
- Which scenario gives the largest estimate for the slope?
  - (Write your response here):
- Does the confidence interval for Scenario A include zero? (NB. A confidence interval includes zero if `Lower < 0 < Upper`.)
  - (Write your response here):
- Does the confidence interval for Scenario B include zero?
  - (Write your response here):
- Does the confidence interval for Scenario C include zero?
  - (Write your response here):
- If a confidence interval includes zero, this indicates that we **cannot** conclude whether the slope is positive or negative. For which scenarios can we not conclude whether the slope is positive or negative?
  - (Write your response here):
:::
<!-- task-end -->
<!-- solution-begin -->
::: {.callout-note icon=false title="Questions for the Class"}
- Which scenario gives the largest estimate for the slope?
  - Scenario B
- Does the confidence interval for Scenario A include zero? (NB. A confidence interval includes zero if `Lower < 0 < Upper`.)
  - Yes
- Does the confidence interval for Scenario B include zero?
  - Yes
- Does the confidence interval for Scenario C include zero?
  - No
- If a confidence interval includes zero, this indicates that we **cannot** conclude whether the slope is positive or negative. For which scenarios can we not conclude whether the slope is positive or negative?
  - Scenarios A and B
:::  
<!-- solution-end -->
  
**General inference** 
  
- How does the slope parameter relate to our hypothesis? As a reminder, our hypothesis is:
  
  > _As the population of Black Americans increases (decreases), the level of energy expenditure increases (decreases)._
  
<!-- task-begin -->

  - (Write your response here):

<!-- task-end -->
<!-- solution-begin -->
  
  - The slope parameter is directly related to our hypothesis. A positive slope is in agreement with our hypothesis.
  
<!-- solution-end -->
  
Let's return to the posterior from our model for the Massachusetts data and use the same reasoning as above to make sense of the results.

```{r repeat-mle-MA}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
df_model_MA %>% 
  select(term, lower, estimate, upper) %>% 
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "percent_black_or_african_american_alone" ~ "Slope"
    )
  ) %>% 
  mutate(across(
    c(lower, estimate, upper),
    ~round(., digits = 1)
  )) %>% 
  
  select(Term = term, Lower = lower, Estimate = estimate, Upper = upper) %>% 
  knitr::kable()
```

::: {.callout-note icon="false" title="Questions for the Class"}
- For Massachusetts, does the fitted model support or contradict our hypothesis? As a reminder, our hypothesis is:

    > *As the population of Black Americans increases (decreases), the level of energy expenditure increases (decreases).*
    
<!-- task-begin -->
  - (Write your response here):
- How confident are you in the model results? Why?
  - (Write your response here):
<!-- task-end -->
<!-- solution-begin -->
  - The fitted model supports our hypothesis (the estimated slope is positive).
- How confident are you in the model results? Why?
  - Fairly confident; the model gives a CI for the slope parameter that does not include zero.
<!-- solution-end -->
:::

## Study the prediction

Frequentist analysis with our model $B = m P + b + \epsilon$ produces a "best-fit" line along with a "confidence band" created by the uncertainty in the estimated parameters $m, b$. For instance, the following visualizes the maximum likelihood estimated line against the Massachusetts data. This object appears as a single best-fit line with a transparent confidence band.

```{r}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
df_MA_pred <-  
  tibble(percent_black_or_african_american_alone = seq(
    min(df_MA$percent_black_or_african_american_alone),
    max(df_MA$percent_black_or_african_american_alone),
    length.out = 100
  ))

df_MA_pred <-
  bind_cols(
    df_MA_pred,
    predict(
      model_MA,
      interval = 'confidence',
      newdata = df_MA_pred
    )
  )

df_MA_pred %>% 

  ggplot(aes(
    x = percent_black_or_african_american_alone,
  )) +
  geom_ribbon(
    aes(ymin = lwr, ymax = upr),
    fill = "blue",
    alpha = 1/3
  ) +
  geom_line(
    aes(y = fit),
    linewidth = 0.7,
    color = "blue"
  ) +
  geom_point(
    data = df_MA,
    mapping = aes(y = energy_burden_percentile),
    size = 0.1
  ) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    x = "Percent Black Census Tract",
    y = "Energy Burden Percentile",
  )
```

We can use this kind of plot (predictions against observed data) as a way to sanity check the model. You'll do this in the following questions.

::: {.callout-note icon="false" title="Questions for the Class"}
- How well does the prediction (transparent blue line) agree with the data (black dots)? Does the line follow the same general trend as the data?
<!-- task-begin -->
  - (Write your response here):
<!-- task-end -->
<!-- solution-begin -->
  - The prediction line tends to agree with the data.
<!-- solution-end -->
:::

Next, we will apply the same statistical modeling approach to study trends in other states.

# Colorado

The following MLE estimates come from a random subset ($n=500$) of the census bureau tracts ($n=1249$).

```{r fit-CO}
#| include: false
#| echo: false
#| cache: true
set.seed(102)
df_CO <- 
  df_data %>% 
  filter(
    str_detect(state_territory, "Colorado"),
    !is.na(percent_black_or_african_american_alone),
    !is.na(energy_burden_percentile)
  ) %>% 
  slice_sample(n = 500) %>% # Take a random subset of the data
  select(energy_burden_percentile, percent_black_or_african_american_alone)

model_CO <- 
  lm(
    data = df_CO,
    formula = energy_burden_percentile ~ percent_black_or_african_american_alone,
  )
```

<!-- solution-begin -->
::: {.callout-note icon="false" title="Instructor Note: Sampling"}
A finer point on estimation that we are not emphasizing in this activity is the difference between sample and population parameters. Formally, if we were to fit the model using all of the relevant CEJS data, we would have the full population---all census tracts in the state. The code above takes a uniform random subset of 500 rows from the dataset so the CI have a meaningful interpretation.
:::
<!-- solution-end -->

```{r mle-CO}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
df_model_CO <- 
  model_CO %>% 
  tidy() %>% 
  mutate(
    lower = estimate - 2 * std.error,
    upper = estimate + 2 * std.error,
  )

df_model_CO %>% 
  select(term, lower, estimate, upper) %>% 
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "percent_black_or_african_american_alone" ~ "Slope"
    )
  ) %>% 
  mutate(across(
    c(lower, estimate, upper),
    ~round(., digits = 1)
  )) %>% 
  
  select(Term = term, Lower = lower, Estimate = estimate, Upper = upper) %>% 
  knitr::kable()
```

::: {.callout-note icon="false" title="Studying Model Results"}
- What does the model suggest about the trend of energy burden with percent Black in Colorado? 
  - (Write your response here):
- How confident are you in your conclusion? Why?
  - (Write your response here):
:::

<!-- solution-begin -->
- What does the model suggest about the trend of energy burden with percent Black in Colorado? 
  - Based on the Estimate, the trend is actually *negative*, which directly contradicts our hypothesis.
- How confident are you in your conclusion? Why?
  - One should have low confidence in these results, as the confidence interval includes zero. 
<!-- solution-end -->

## Study the predictions

(Describe posterior predictions)

```{r}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
df_CO_pred <-  
  tibble(percent_black_or_african_american_alone = seq(
    min(df_CO$percent_black_or_african_american_alone),
    max(df_CO$percent_black_or_african_american_alone),
    length.out = 100
  ))

df_CO_pred <- 
  bind_cols(
    df_CO_pred,
    predict(
      model_CO, 
      interval = 'confidence',
      newdata = df_CO_pred
    )
  )

df_CO_pred %>% 

  ggplot(aes(
    x = percent_black_or_african_american_alone,
  )) +
  geom_ribbon(
    aes(ymin = lwr, ymax = upr),
    fill = "blue",
    alpha = 1/3
  ) +
  geom_line(
    aes(y = fit),
    linewidth = 0.7,
    color = "blue"
  ) +
  geom_point(
    data = df_CO,
    mapping = aes(y = energy_burden_percentile),
    size = 0.1
  ) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    x = "Percent Black Census Tract",
    y = "Energy Burden Percentile",
  )
```

-   How well do the posterior predictions agree with the data?

# Florida

In some cases, we may find that gathering more data is simply not possible. Let's suppose that, for some reason, Florida is unwilling to provide all of their energy burden data, and instead provide only $n=25$ of their $n=4{,}245$ census tracts. In this case, the confidence intervals will tend to be very wide due (in part) to limited data.

```{r}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
set.seed(103)

df_FL <- 
  df_data %>% 
  filter(state_territory == "Florida") %>% 
  slice_sample(n = 25)

df_FL %>% 
  ggplot(aes(
    percent_black_or_african_american_alone,
    energy_burden_percentile
  )) +
  geom_point(size = 1.0) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    x = "Percent Black Census Tract",
    y = "Energy Burden Percentile",
  )
```

```{r fit-FL}
#| include: false
#| echo: false
#| cache: true
model_FL <- 
  lm(
    data = df_FL,
    formula = energy_burden_percentile ~ percent_black_or_african_american_alone,
  )
```



```{r mle-FL}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8
df_model_FL <- 
  model_FL %>% 
  tidy() %>% 
  mutate(
    lower = estimate - 2 * std.error,
    upper = estimate + 2 * std.error,
  )

df_model_FL %>% 
  select(term, lower, estimate, upper) %>% 
  mutate(
    term = case_when(
      term == "(Intercept)" ~ "Intercept",
      term == "percent_black_or_african_american_alone" ~ "Slope"
    )
  ) %>% 
  mutate(across(
    c(lower, estimate, upper),
    ~round(., digits = 1)
  )) %>% 
  
  select(Term = term, Lower = lower, Estimate = estimate, Upper = upper) %>% 
  knitr::kable()
```

-   Do the CI exclude zero?

## Study the MLE predictions

(Describe posterior predictions)

```{r}
#| warning: false
#| echo: false
#| fig-align: center
#| fig-height: 8

df_FL_pred <-  
  tibble(percent_black_or_african_american_alone = seq(
    min(df_FL$percent_black_or_african_american_alone),
    max(df_FL$percent_black_or_african_american_alone),
    length.out = 100
  ))

df_FL_pred <- 
  bind_cols(
    df_FL_pred,
    predict(
      model_FL, 
      interval = 'confidence',
      newdata = df_FL_pred
    )
  )

df_FL_pred %>% 

  ggplot(aes(
    x = percent_black_or_african_american_alone,
  )) +
  geom_ribbon(
    aes(ymin = lwr, ymax = upr),
    fill = "blue",
    alpha = 1/3
  ) +
  geom_line(
    aes(y = fit),
    linewidth = 0.7,
    color = "blue"
  ) +
  geom_point(
    data = df_FL,
    mapping = aes(y = energy_burden_percentile),
    size = 1.0
  ) +
  scale_x_continuous(labels = scales::percent) +
  theme_minimal() +
  labs(
    x = "Percent Black Census Tract",
    y = "Energy Burden Percentile",
  )
```

-   How well do the posterior predictions agree with the data?
